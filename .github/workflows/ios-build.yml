name: iOS Build

on:
  workflow_run:
    workflows: ["Auto Version Bump"]
    types:
      - completed
    branches: [main]
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  # Signed build using manual certificate (.p12)
  build-ios-signed:
    runs-on: macos-26
    # Only run if triggered by workflow_dispatch, tag push, or if version-bump succeeded
    if: ${{ github.event_name == 'workflow_dispatch' || github.event_name == 'push' || github.event.workflow_run.conclusion == 'success' }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          cache: true

      - name: Setup Ruby (for CocoaPods and xcodeproj)
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.2'
          bundler-cache: true

      - name: Install xcodeproj gem
        run: gem install xcodeproj

      - name: Install Codemagic CLI Tools
        run: |
          brew install pipx
          pipx ensurepath
          pipx install codemagic-cli-tools
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: Setup keychain and certificate
        env:
          IOS_CERTIFICATE_BASE64: ${{ secrets.IOS_DIST_CERTIFICATE_BASE64 }}
          IOS_CERTIFICATE_PASSWORD: ${{ secrets.IOS_DIST_CERTIFICATE_PASSWORD }}
        run: |
          # Decode certificate
          echo "$IOS_CERTIFICATE_BASE64" | base64 --decode > certificate.p12

          # Create temporary keychain
          KEYCHAIN_PATH=$RUNNER_TEMP/app-signing.keychain-db
          KEYCHAIN_PASSWORD=$(openssl rand -base64 32)

          security create-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH
          security set-keychain-settings -lut 21600 $KEYCHAIN_PATH
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH

          # Import certificate to keychain
          security import certificate.p12 -P "$IOS_CERTIFICATE_PASSWORD" -A -t cert -f pkcs12 -k $KEYCHAIN_PATH
          security set-key-partition-list -S apple-tool:,apple: -k "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH
          security list-keychain -d user -s $KEYCHAIN_PATH

          # Save keychain path for later cleanup
          echo "KEYCHAIN_PATH=$KEYCHAIN_PATH" >> $GITHUB_ENV
          echo "KEYCHAIN_PASSWORD=$KEYCHAIN_PASSWORD" >> $GITHUB_ENV

          # Cleanup certificate file
          rm certificate.p12

      - name: Setup App Store Connect API Key
        env:
          APP_STORE_CONNECT_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
          APP_STORE_CONNECT_KEY_ID: ${{ secrets.APP_STORE_CONNECT_KEY_ID }}
          APP_STORE_CONNECT_PRIVATE_KEY: ${{ secrets.APP_STORE_CONNECT_PRIVATE_KEY }}
        run: |
          mkdir -p ~/.appstoreconnect/private_keys
          echo "$APP_STORE_CONNECT_PRIVATE_KEY" > ~/.appstoreconnect/private_keys/AuthKey_${APP_STORE_CONNECT_KEY_ID}.p8

      - name: Install provisioning profile
        env:
          IOS_PROVISIONING_PROFILE_BASE64: ${{ secrets.IOS_PROVISIONING_PROFILE_BASE64 }}
        run: |
          # Decode provisioning profile
          echo "$IOS_PROVISIONING_PROFILE_BASE64" | base64 --decode > profile.mobileprovision

          # Extract UUID and install profile
          mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
          UUID=$(/usr/libexec/PlistBuddy -c 'Print :UUID' /dev/stdin <<< $(security cms -D -i profile.mobileprovision))
          cp profile.mobileprovision ~/Library/MobileDevice/Provisioning\ Profiles/${UUID}.mobileprovision
          echo "Installed provisioning profile with UUID: $UUID"

          # Clean up
          rm profile.mobileprovision

          # Set up Xcode project signing
          xcode-project use-profiles || true

      - name: Create .env file
        env:
          BEXLY_FREE_AI_KEY: ${{ secrets.BEXLY_FREE_AI_KEY }}
        run: |
          # Create .env file with Bexly Free AI configuration
          cat > .env << EOF
          BEXLY_FREE_AI_URL=https://api.dos.ai/v1
          BEXLY_FREE_AI_KEY=${BEXLY_FREE_AI_KEY}
          BEXLY_FREE_AI_MODEL=Qwen/Qwen3-VL-30B-A3B-Instruct
          EOF

      - name: Get version info
        id: version
        run: |
          VERSION=$(grep 'version:' pubspec.yaml | sed 's/version: //')
          BUILD_NUMBER=$(echo $VERSION | cut -d'+' -f2)
          VERSION_NAME=$(echo $VERSION | cut -d'+' -f1)
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "build_number=$BUILD_NUMBER" >> $GITHUB_OUTPUT
          echo "version_name=$VERSION_NAME" >> $GITHUB_OUTPUT
          echo "üì¶ Building version: $VERSION_NAME (build $BUILD_NUMBER)"

      - name: Install dependencies
        run: flutter pub get

      - name: Precache iOS artifacts
        run: flutter precache --ios

      - name: Install CocoaPods
        run: |
          cd ios
          pod install --repo-update

      - name: Build IPA (${{ steps.version.outputs.build_number }})
        run: |
          xcode-project use-profiles --export-options-plist=ios/ExportOptions.plist
          flutter build ipa --release --export-options-plist=ios/ExportOptions.plist

      - name: Upload IPA artifact
        uses: actions/upload-artifact@v4
        with:
          name: ios-build-${{ steps.version.outputs.build_number }}
          path: build/ios/ipa/*.ipa
          retention-days: 30

      - name: Upload to TestFlight
        env:
          APP_STORE_CONNECT_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
          APP_STORE_CONNECT_KEY_ID: ${{ secrets.APP_STORE_CONNECT_KEY_ID }}
          APP_STORE_CONNECT_USERNAME: ${{ secrets.APP_STORE_CONNECT_USERNAME }}
          APP_STORE_CONNECT_PASSWORD: ${{ secrets.APP_STORE_CONNECT_PASSWORD }}
        run: |
          # Try App Store Connect API first
          if app-store-connect publish \
            --issuer-id "$APP_STORE_CONNECT_ISSUER_ID" \
            --key-id "$APP_STORE_CONNECT_KEY_ID" \
            --private-key @file:~/.appstoreconnect/private_keys/AuthKey_${APP_STORE_CONNECT_KEY_ID}.p8 \
            --path build/ios/ipa/*.ipa; then
            echo "‚úÖ Upload successful via App Store Connect API"
          else
            echo "‚ö†Ô∏è API upload failed, trying App Password fallback..."
            xcrun altool --upload-app \
              --type ios \
              --file build/ios/ipa/*.ipa \
              --username "$APP_STORE_CONNECT_USERNAME" \
              --password "$APP_STORE_CONNECT_PASSWORD"
            echo "‚úÖ Upload successful via App Password"
          fi

      - name: Cleanup keychain
        if: always()
        run: |
          security delete-keychain $KEYCHAIN_PATH || true
