name: iOS Build

on:
  push:
    branches: [main]
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  # Unsigned build for testing
  build-ios-unsigned:
    runs-on: macos-14
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'master'
          cache: true

      - name: Install dependencies
        run: flutter pub get

      - name: Setup Ruby (for CocoaPods)
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.2'
          bundler-cache: true

      - name: Install CocoaPods
        run: |
          cd ios
          pod install --repo-update

      - name: Build iOS (no codesign)
        run: flutter build ios --release --no-codesign

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ios-build-unsigned
          path: build/ios/iphoneos/Runner.app
          retention-days: 7

  # Signed build with Codemagic CLI (automatic certificate management)
  # TODO: Enable when iOS Distribution Certificate is available
  # Requires: Someone with Mac to create certificate and export .p12 file
  build-ios-signed:
    runs-on: macos-14
    if: false # Disabled until certificate is available
    # if: github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/v')
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'master'
          cache: true

      - name: Install Codemagic CLI Tools
        run: |
          brew install pipx
          pipx ensurepath
          pipx install codemagic-cli-tools

      - name: Setup App Store Connect API Key
        env:
          APP_STORE_CONNECT_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
          APP_STORE_CONNECT_KEY_ID: ${{ secrets.APP_STORE_CONNECT_KEY_ID }}
          APP_STORE_CONNECT_PRIVATE_KEY: ${{ secrets.APP_STORE_CONNECT_PRIVATE_KEY }}
        run: |
          # Create API key file
          mkdir -p ~/.appstoreconnect/private_keys
          echo "$APP_STORE_CONNECT_PRIVATE_KEY" > ~/.appstoreconnect/private_keys/AuthKey_${APP_STORE_CONNECT_KEY_ID}.p8

      - name: Fetch signing certificates
        env:
          APP_STORE_CONNECT_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
          APP_STORE_CONNECT_KEY_ID: ${{ secrets.APP_STORE_CONNECT_KEY_ID }}
          BUNDLE_ID: com.joy.bexly
        run: |
          export PATH="$HOME/.local/bin:$PATH"
          # Initialize keychain
          keychain initialize

          # Fetch or create distribution certificate
          app-store-connect fetch-signing-files "$BUNDLE_ID" \
            --type IOS_APP_STORE \
            --issuer-id "$APP_STORE_CONNECT_ISSUER_ID" \
            --key-id "$APP_STORE_CONNECT_KEY_ID" \
            --private-key @file:~/.appstoreconnect/private_keys/AuthKey_${APP_STORE_CONNECT_KEY_ID}.p8 \
            --create

          # Add certificates to keychain
          keychain add-certificates

          # Set up Xcode project signing
          xcode-project use-profiles

      - name: Install dependencies
        run: flutter pub get

      - name: Setup Ruby (for CocoaPods)
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.2'
          bundler-cache: true

      - name: Install CocoaPods
        run: |
          cd ios
          pod install --repo-update

      - name: Build IPA
        run: |
          export PATH="$HOME/.local/bin:$PATH"
          # Generate ExportOptions.plist from provisioning profiles
          xcode-project use-profiles --export-options-plist=ios/ExportOptions.plist
          flutter build ipa --release --export-options-plist=ios/ExportOptions.plist

      - name: Upload IPA artifact
        uses: actions/upload-artifact@v4
        with:
          name: ios-build-signed
          path: build/ios/ipa/*.ipa
          retention-days: 30

      - name: Upload to TestFlight
        env:
          APP_STORE_CONNECT_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
          APP_STORE_CONNECT_KEY_ID: ${{ secrets.APP_STORE_CONNECT_KEY_ID }}
        run: |
          export PATH="$HOME/.local/bin:$PATH"
          app-store-connect publish \
            --issuer-id "$APP_STORE_CONNECT_ISSUER_ID" \
            --key-id "$APP_STORE_CONNECT_KEY_ID" \
            --private-key @file:~/.appstoreconnect/private_keys/AuthKey_${APP_STORE_CONNECT_KEY_ID}.p8 \
            --path build/ios/ipa/*.ipa

      - name: Cleanup keychain
        if: always()
        run: |
          export PATH="$HOME/.local/bin:$PATH"
          keychain delete || true
